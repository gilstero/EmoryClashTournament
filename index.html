<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CLASH BASH</title>
  <link rel="icon" href="https://www.freeiconspng.com/img/46155" />
  <style>
    :root{
      --royal-blue:#1f58ad;--deep:#0b2b6b;--gold:#f6c34a;--stone:#24447f;
      --ok:#2ecc71;--bad:#e74c3c;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:linear-gradient(180deg,var(--royal-blue),var(--deep));
      color:#fff;
      min-height:100vh;
    }
    .shell{max-width:900px;margin:0 auto;padding:24px;}
    header{text-align:center;margin-bottom:20px;}
    h1{margin:0;font-size:clamp(26px,4vw,38px);color:var(--gold);}
    p.subtitle{opacity:.85;font-size:15px;margin-top:4px;}
    .card{
      background:linear-gradient(180deg,var(--stone),#132a57);
      border:1px solid #ffffff22;border-radius:16px;
      padding:24px;box-shadow:0 10px 24px #0005;margin-top:20px;
    }
    .note{font-size:15px;opacity:.9;line-height:1.5;}
    form.grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:14px;align-items:end;margin-top:18px;
    }
    label{display:block;font-size:14px;margin-bottom:4px;opacity:.9}
    input{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid #ffffff30;background:#ffffff10;
      color:#fff;outline:none;
    }
    input::placeholder{color:#ccc;}
    button{
      border:none;border-radius:12px;padding:10px 14px;
      background:var(--gold);color:#222;cursor:pointer;
      font-weight:700;transition:.2s;
    }
    button:hover{opacity:.9;}
    button.small{font-size:13px;padding:6px 10px;border-radius:8px;margin-left:8px;}
    button.danger{background:var(--bad);color:#fff;}
    .row{
      display:grid;grid-template-columns:1fr 1fr 1fr;
      gap:10px;align-items:center;padding:10px;
      border-bottom:1px solid #ffffff1e;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:#ffffff18;border:1px solid #ffffff24;
      border-radius:999px;padding:4px 10px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:var(--ok)} .dot.red{background:var(--bad)}
    .muted{opacity:.8}
    .footer{opacity:.7;font-size:12px;margin-top:14px;text-align:center;}
  </style>
</head>
<body>
<div class="shell">
  <header>
    <h1>Emory Royale ‚Äî Clash Royale Tournament</h1>
    <p class="subtitle">Join the battle. Prove your skill. Claim the crown.</p>
  </header>

  <section class="card">
    <h2>How It Works</h2>
    <p class="note">
      1Ô∏è‚É£ Sign up with your <b>first name</b>, <b>last name</b>, and <b>Emory email</b>.<br/>
      2Ô∏è‚É£ Send the <b>$5 buy-in</b> to <b>Venmo @Dylan-Patel-06697</b>.<br/>
      3Ô∏è‚É£ Once payment is confirmed, your status turns <span style="color:var(--ok)">green</span>.<br/>
      4Ô∏è‚É£ If payment isn‚Äôt received within <b>24 hours</b>, your sign-up is removed automatically.<br/>
      ‚ö° The list below updates live for everyone. <br/> <br/>
      The award structure for the tournament is as follows: <br/>
      1st: <b>$100</b> <br/>
      2nd: <b>$25 and Pass Royale</b> <br/>
      3rd: <b>Pass Royale</b> <br/>
      4th: <b>Pass Royale</b> <br/>
      
    </p>
  </section>

  <section class="card">
    <h2>Sign Up</h2>
    <form id="signupForm" class="grid" autocomplete="on">
      <div>
        <label>First name</label>
        <input id="firstName" required maxlength="40" />
      </div>
      <div>
        <label>Last name</label>
        <input id="lastName" required maxlength="40" />
      </div>
      <div>
        <label>Emory email</label>
        <input id="email" type="email" required placeholder="netid@emory.edu" />
      </div>
      <div>
        <button type="submit">Join Tournament</button>
      </div>
    </form>
  </section>

  <section class="card">
    <h2>Participants</h2>
    <div class="muted" id="count"></div>
    <div class="row muted" style="font-weight:700;">
      <div>First</div><div>Last</div><div>Status</div>
    </div>
    <div id="list"></div>
    <p class="footer">Unpaid entries older than 24 hours are removed automatically.</p>
  </section>
  
  <section class="card">
    <h2>üèÜ Leaderboard</h2>
    <p class="note muted">
      The leaderboard will appear here once the tournament starts. Bracket standings and match results will be updated live!
    </p>
    <div id="leaderboard"></div>
  </section>

  <section class="card">
    <h2>‚è±Ô∏èCountdown‚è±Ô∏è</h2>
    <p class="note muted">
      Next Tournament: ...
    </p>
    <div id="countdown"></div>
  </section>
  
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://xlxqdotveahulypkrxgq.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhseHFkb3R2ZWFodWx5cGtyeGdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NTQ2OTQsImV4cCI6MjA3NTMzMDY5NH0.ju9D30ie4AJjboshKEMDkWFHqN-mGx_Eof_RGYBh1LI";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ----- Signup -----
const form = document.getElementById("signupForm");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const first = document.getElementById("firstName").value.trim();
  const last = document.getElementById("lastName").value.trim();
  const email = document.getElementById("email").value.trim().toLowerCase();

  if (!email.endsWith("@emory.edu")) {
    alert("Please use your @emory.edu email");
    return;
  }

  try {
    const res = await fetch("/api/signup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ first_name: first, last_name: last, emory_email: email }),
    });
    const data = await res.json();
    if (!res.ok) {
      alert("Error: " + data.error);
      return;
    }
    localStorage.setItem("myEmail", email);
    alert("Signed up! Check the list below.");
    form.reset();
    await refreshList();
  } catch (err) {
    alert("Network error: " + err.message);
  }
});

// ----- List + Realtime -----
const list = document.getElementById("list");
const count = document.getElementById("count");

async function refreshList() {
  const { data, error } = await sb
    .from("participants")
    .select("first_name,last_name,emory_email,paid,created_at")
    .order("paid",{ascending:true})
    .order("created_at",{ascending:true});
  if (error) { console.error(error); return; }
  render(data);
}

function render(rows) {
  list.innerHTML = "";
  const now = new Date();
  const myEmail = localStorage.getItem("myEmail");
  const keep = rows.filter(
    (r) => r.paid || now - new Date(r.created_at) < 24 * 60 * 60 * 1000
  );
  count.textContent = `${keep.length} participant${keep.length===1?"":"s"}`;
  
  keep.forEach((r) => {
    const row = document.createElement("div");
    row.className = "row";
    const statusDot = `
      <span class="pill">
        <span class="dot ${r.paid ? "green" : "red"}"></span>
        ${r.paid ? "Paid" : "Unpaid"}
      </span>
    `;
    const mine = r.emory_email === myEmail;
    const withdraw = mine ? `<button class="small danger" data-email="${r.emory_email}">Withdraw</button>` : "";
    row.innerHTML = `
      <div>${escapeHtml(r.first_name)}</div>
      <div>${escapeHtml(r.last_name)}</div>
      <div>${statusDot} ${withdraw}</div>
    `;
    list.appendChild(row);
  });

  // attach remove handlers
  list.querySelectorAll("button[data-email]").forEach((btn)=>{
    btn.addEventListener("click", async()=>{
      const email=btn.dataset.email;
      if(!confirm("Remove yourself from the tournament?"))return;
      const res=await fetch(`/api/signup?email=${encodeURIComponent(email)}`,{method:"DELETE"});
      if(res.ok){
        localStorage.removeItem("myEmail");
        alert("Removed from the tournament.");
        await refreshList();
      }else{
        alert("Error removing entry.");
      }
    });
  });
}

sb
  .channel("realtime:participants")
  .on("postgres_changes",{event:"*",schema:"public",table:"participants"},refreshList)
  .subscribe();

await refreshList();

function escapeHtml(s){
  return (s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
}
</script>
</body>
</html>
